---
- name: Install Neovim and dependencies
  package:
    name: "{{ editor_packages }}"
    state: present
  become: yes

- name: Ensure Volta directory structure exists
  file:
    path: "{{ ansible_facts.user_dir }}/.local/share/volta/bin"
    state: directory
    mode: '0755'
  become: no
  become_user: "{{ ansible_facts.user_id }}"

- name: Check if Volta is installed
  stat:
    path: "{{ ansible_facts.user_dir }}/.local/share/volta/bin/volta"
  register: volta_bin

- name: Get latest Volta version
  uri:
    url: "https://volta.sh/latest-version"
    return_content: yes
  register: volta_latest
  become: no
  become_user: "{{ ansible_facts.user_id }}"

- name: Download and install Volta ({{ volta_latest.content | trim }})
  unarchive:
    src: "https://github.com/volta-cli/volta/releases/download/v{{ volta_latest.content | trim }}/volta-{{ volta_latest.content | trim }}-linux.tar.gz"
    dest: "{{ ansible_facts.user_dir }}/.local/share/volta/bin"
    remote_src: yes
    mode: '0755'
  become: no
  become_user: "{{ ansible_facts.user_id }}"
  when: not volta_bin.stat.exists

- name: Install Node.js
  command: "{{ ansible_facts.user_dir }}/.local/share/volta/bin/volta install node"
  become: no
  become_user: "{{ ansible_facts.user_id }}"
  changed_when: false # Volta handles "already installed" logic gracefully

- name: Install NPM
  command: "{{ ansible_facts.user_dir }}/.local/share/volta/bin/volta install npm"
  become: no
  become_user: "{{ ansible_facts.user_id }}"
  changed_when: false

- name: Install Yarn
  command: "{{ ansible_facts.user_dir }}/.local/share/volta/bin/volta install yarn"
  become: no
  become_user: "{{ ansible_facts.user_id }}"
  changed_when: false

- name: Ensure .config directory exists
  file:
    path: "{{ ansible_facts.user_dir }}/.config"
    state: directory
    mode: '0755'

- name: Symlink editor configuration directories
  file:
    src: "{{ dotfiles_dir }}/{{ item }}"
    dest: "{{ ansible_facts.user_dir }}/.config/{{ item }}"
    state: link
    force: yes
  loop: "{{ editor_symlinks }}"
  ignore_errors: yes

- name: Install pipx
  package:
    name: python-pipx
    state: present
  become: yes

- name: Install jupytext via pipx
  command: pipx install jupytext
  args:
    creates: "{{ ansible_facts.user_dir }}/.local/bin/jupytext"
  become: no
  become_user: "{{ ansible_facts.user_id }}"
